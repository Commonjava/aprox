<!--

    Copyright (C) 2011 Red Hat, Inc. (jdcasey@commonjava.org)

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>org.commonjava.indy</groupId>
    <artifactId>indy-deployments</artifactId>
    <version>0.99.4-SNAPSHOT</version>
  </parent>
  
  <groupId>org.commonjava.indy.docker</groupId>
  <artifactId>indy-docker-images</artifactId>
  <packaging>pom</packaging>

  <name>Indy :: Docker Images :: Parent</name>
  
  <modules>
    <module>base</module>
    <module>gogs-testbase</module>
    <module>savant</module>
  </modules>

  <properties>
    <flavor>unknown</flavor>
    <tagVer>dev</tagVer>
    <dockerRegistry>docker.io</dockerRegistry>
    <dockerUser>commonjava</dockerUser>
    <imageName>indy-${flavor}</imageName>
    <dockerHost>tcp://localhost:2375</dockerHost>
  </properties>


  <profiles>
    <profile>
      <id>release</id>
      <properties>
        <tagVer>${project.version}</tagVer>
      </properties>
    </profile>
    <profile>
      <id>docker</id>

      <build>
        <pluginManagement>
          <plugins>
            <plugin>
              <artifactId>maven-dependency-plugin</artifactId>
              <version>2.10</version>
              <executions>
                <execution>
                  <id>unpack-base</id>
                  <goals>
                    <goal>unpack-dependencies</goal>
                  </goals>
                  <phase>prepare-package</phase>
                  <configuration>
                    <includeArtifactIds>indy-docker-base</includeArtifactIds>
                    <outputDirectory>${project.build.directory}/dependency</outputDirectory>
                  </configuration>
                </execution>
                <execution>
                  <id>unpack-gogs</id>
                  <goals>
                    <goal>unpack-dependencies</goal>
                  </goals>
                  <phase>prepare-package</phase>
                  <configuration>
                    <includeArtifactIds>indy-docker-gogs-testbase</includeArtifactIds>
                    <outputDirectory>${project.build.directory}/dependency/gogs</outputDirectory>
                  </configuration>
                </execution>
              </executions>
            </plugin>
            <plugin>
              <groupId>net.wouterdanes.docker</groupId>
              <artifactId>docker-maven-plugin</artifactId>
              <configuration>
                <serverId>registry.hub.docker.com</serverId>
              </configuration>
              <executions>
                <execution>
                  <id>build</id>
                  <goals>
                    <goal>build-images</goal>
                  </goals>
                  <configuration>
                    <images>
                      <!-- TODO: Move this into the gogs-testbase module instead of building it here. -->
                      <image>
                        <id>${dockerRegistry}/${dockerUser}/gogs-test-appliance:${tagVer}</id>
                        <dockerFile>${project.build.directory}/dependency/gogs/Dockerfile</dockerFile>
                        <artifacts>
                          <artifact>
                            <file>${project.build.directory}/dependency/gogs/data</file>
                            <dest>data</dest>
                          </artifact>
                        </artifacts>
                      </image>
                      <image>
                        <id>${dockerRegistry}/${dockerUser}/${imageName}</id>
                        <dockerFile>${project.build.directory}/dependency/image-base/Dockerfile</dockerFile>
                        <artifacts>
                          <artifact>
                            <file>${project.build.directory}/dependency/image-base/scripts</file>
                            <dest>maven/scripts</dest>
                          </artifact>
                        </artifacts>
                        <mavenArtifacts>
                          <mavenArtifact>
                            <dependency>org.commonjava.indy.launch:indy-launcher-${flavor}:tar.gz:launcher:${project.version}</dependency>
                            <dest>maven/indy.tar.gz</dest>
                          </mavenArtifact>
                        </mavenArtifacts>
                        <keep>true</keep>
                        <nameAndTag>${dockerRegistry}/${dockerUser}/${imageName}</nameAndTag>
                      </image>
                    </images>
                  </configuration>
                </execution>
                <execution>
                  <id>start-and-stop</id>
                  <goals>
                    <goal>start-containers</goal>
                    <goal>stop-containers</goal>
                  </goals>
                  <configuration>
                    <containers>
                      <container>
                        <id>gogs-test-appliance</id>
                        <image>${dockerRegistry}/${dockerUser}/gogs-test-appliance:${tagVer}</image>
                      </container>

                      <container>
                        <id>indy-vanilla</id>
                        <image>${dockerRegistry}/${dockerUser}/${imageName}</image>
                      </container>

                      <container>
                        <id>indy-git-root</id>
                        <image>${dockerRegistry}/${dockerUser}/${imageName}</image>
                        <env>
                          <INDY_ETC_URL>http://gogs:3000/commonjava/indy-config.git</INDY_ETC_URL>
                        </env>
                        <links>
                          <link>
                            <containerId>gogs-test-appliance</containerId>
                            <containerAlias>gogs</containerAlias>
                          </link>
                        </links>
                      </container>

                      <container>
                        <id>indy-git-branch</id>
                        <image>${dockerRegistry}/${dockerUser}/${imageName}</image>
                        <env>
                          <INDY_ETC_URL>http://gogs:3000/commonjava/indy-config.git</INDY_ETC_URL>
                          <INDY_ETC_BRANCH>test-branch</INDY_ETC_BRANCH>
                        </env>
                        <links>
                          <link>
                            <containerId>gogs-test-appliance</containerId>
                            <containerAlias>gogs</containerAlias>
                          </link>
                        </links>
                      </container>

                      <container>
                        <id>indy-git-subpath</id>
                        <image>${dockerRegistry}/${dockerUser}/${imageName}</image>
                        <env>
                          <INDY_ETC_URL>http://gogs:3000/commonjava/indy-config.git</INDY_ETC_URL>
                          <INDY_ETC_SUBPATH>subpath</INDY_ETC_SUBPATH>
                        </env>
                        <links>
                          <link>
                            <containerId>gogs-test-appliance</containerId>
                            <containerAlias>gogs</containerAlias>
                          </link>
                        </links>
                      </container>
                    </containers>
                  </configuration>
                </execution>
                <execution>
                  <id>tag-and-push</id>
                  <goals>
                    <goal>tag-images</goal>
                    <goal>push-images</goal>
                  </goals>
                  <configuration>
                    <images>
                      <image>
                        <id>${dockerRegistry}/${dockerUser}/${imageName}</id>
                        <push>true</push>
                        <tags>
                          <tag>${dockerRegistry}/${dockerUser}/${imageName}</tag>
                        </tags>
                      </image>
                    </images>
                  </configuration>
                </execution>
              </executions>
            </plugin>
          </plugins>
        </pluginManagement>
      </build>
    </profile>
    <profile>
      <id>f8-docker</id>

      <build>
        <pluginManagement>
          <plugins>
            <plugin>
              <artifactId>maven-dependency-plugin</artifactId>
              <version>2.10</version>
              <executions>
                <execution>
                  <id>unpack-base</id>
                  <goals>
                    <goal>unpack-dependencies</goal>
                  </goals>
                  <phase>prepare-package</phase>
                  <configuration>
                    <includeArtifactIds>indy-docker-base</includeArtifactIds>
                  </configuration>
                </execution>
              </executions>
            </plugin>
            <plugin>
              <groupId>io.fabric8</groupId>
              <artifactId>docker-maven-plugin</artifactId>
              <version>0.15.9</version>
              <extensions>true</extensions>

              <dependencies>
                <dependency>
                  <groupId>org.commonjava.indy.tools</groupId>
                  <artifactId>indy-assemblies</artifactId>
                  <version>${project.version}</version>
                </dependency>
              </dependencies>

              <configuration>
                <skip>${disableLauncher}</skip>
                <dockerHost>${dockerHost}</dockerHost>
                <authConfig>
                  <push>
                    <username>${dockerUser}</username>
                    <password>${docker.password}</password>
                  </push>
                </authConfig>
                <images>
                  <image>
                    <name>${dockerRegistry}/${dockerUser}/gogs-test-appliance</name>
                    <alias>gogs-test-appliance</alias>
                    <build>
                      <from>gogs/gogs</from>
                      <assembly>
                        <mode>dir</mode>
                        <basedir>/data</basedir>
                        <inline>
                          <dependencySets>
                            <dependencySet>
                              <scope>provided</scope>
                              <includes>
                                <include>org.commonjava.indy.docker:indy-docker-gogs-testbase*</include>
                              </includes>
                              <unpack>true</unpack>
                              <outputDirectory>/</outputDirectory>
                            </dependencySet>
                          </dependencySets>
                        </inline>
                      </assembly>
                    </build>
                    <run>
                      <ports>
                        <port>gogs.port:3000</port>
                      </ports>
                      <wait>
                        <tcp>
                          <ports>
                            <port>3000</port>
                          </ports>
                        </tcp>
                      </wait>
                      <log>
                        <file>${project.build.directory}/gogs.log</file>
                      </log>
                    </run>
                  </image>
    <!--               <image>
                    <name>git-clone-test</name>
                    <build>
                      <from>centos</from>
                      <runCmds>
                        <run>yum -y install git</run>
                      </runCmds>
                      <cmd>git clone http://gogs-test-appliance:3000/commonjava/indy-config.git</cmd>
                    </build>
                    <run>
                      <links>
                        <link>gogs-test-appliance:gogs-test-appliance</link>
                      </links>
                      <log>
                        <file>${project.build.directory}/git-test.log</file>
                      </log>
                    </run>
                  </image> -->
                  <image>
                    <name>${dockerRegistry}/${dockerUser}/${imageName}</name>
                    <alias>indy-vanilla</alias>
                    <build>
                      <dockerFile>${project.build.directory}/dependency/image-base/Dockerfile</dockerFile>
                      <assembly>
                        <descriptorRef>docker-launcher</descriptorRef>
                      </assembly>
                      <tags>
                        <tag>${tagVer}</tag>
                      </tags>
                    </build>
                    <run>
                      <ports>
                        <port>indy-vanilla.port:8080</port>
                      </ports>
                      <wait>
                        <http>
                          <url>http://localhost:${indy-vanilla.port}/</url>
                        </http>
                      </wait>
                      <log>
                        <file>${project.build.directory}/indy-vanilla.log</file>
                      </log>
                    </run>
                  </image>
                  <image>
                    <name>${dockerRegistry}/${dockerUser}/${imageName}</name>
                    <alias>indy-git-root</alias>
                    <run>
                      <env>
                        <INDY_ETC_URL>http://gogs:3000/commonjava/indy-config.git</INDY_ETC_URL>
                      </env>
                      <ports>
                        <port>indy-git-root.port:8080</port>
                      </ports>
                      <links>
                        <link>gogs-test-appliance:gogs</link>
                      </links>
                      <wait>
                        <http>
                          <url>http://localhost:${indy-git-root.port}/</url>
                        </http>
                      </wait>
                      <log>
                        <file>${project.build.directory}/indy-git-root.log</file>
                      </log>
                    </run>
                  </image>
                  <image>
                    <name>${dockerRegistry}/${dockerUser}/${imageName}</name>
                    <alias>indy-git-branch</alias>
                    <run>
                      <env>
                        <INDY_ETC_URL>http://gogs:3000/commonjava/indy-config.git</INDY_ETC_URL>
                        <INDY_ETC_BRANCH>test-branch</INDY_ETC_BRANCH>
                      </env>
                      <ports>
                        <port>indy-git-branch.port:8080</port>
                      </ports>
                      <links>
                        <link>gogs-test-appliance:gogs</link>
                      </links>
                      <wait>
                        <http>
                          <url>http://localhost:${indy-git-branch.port}/</url>
                        </http>
                      </wait>
                      <log>
                        <file>${project.build.directory}/indy-git-branch.log</file>
                      </log>
                    </run>
                  </image>
                  <image>
                    <name>${dockerRegistry}/${dockerUser}/${imageName}</name>
                    <alias>indy-git-subpath</alias>
                    <run>
                      <env>
                        <INDY_ETC_URL>http://gogs:3000/commonjava/indy-config.git</INDY_ETC_URL>
                        <INDY_ETC_SUBPATH>subpath</INDY_ETC_SUBPATH>
                      </env>
                      <ports>
                        <port>indy-git-subpath.port:8080</port>
                      </ports>
                      <links>
                        <link>gogs-test-appliance:gogs</link>
                      </links>
                      <wait>
                        <http>
                          <url>http://localhost:${indy-git-subpath.port}/</url>
                        </http>
                      </wait>
                      <log>
                        <file>${project.build.directory}/indy-git-subpath.log</file>
                      </log>
                    </run>
                  </image>
                </images>
              </configuration>
            </plugin>
          </plugins>
        </pluginManagement>
      </build>
    </profile>
<!-- <profile>
      <id>run-its</id>
      
      <dependencies>
        <dependency>
          <groupId>org.commonjava.indy</groupId>
          <artifactId>indy-ftests-core</artifactId>
        </dependency>
      </dependencies>
      
      <build>
        <pluginManagement>
          <plugins>
            <plugin>
              <artifactId>maven-surefire-plugin</artifactId>
              <configuration>
                <forkCount>${test-forkCount}</forkCount>
                <reuseForks>false</reuseForks>
                <redirectTestOutputToFile>${test-redirectOutput}</redirectTestOutputToFile>
                <dependenciesToScan>
                  <dependency>org.commonjava.indy:indy-ftests-core</dependency>
                </dependenciesToScan> 
              </configuration>
            </plugin>
          </plugins>
        </pluginManagement>
      </build>
    </profile> -->
  </profiles>
  
</project>
