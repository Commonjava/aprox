<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <script type="text/javascript">
    var groupTable;
    
    function reloadGroupConstituents(){
      var select = $('#group-constituents');
      
      $(select).multiselect('destroy');
      $('#group-constituents option').each( function(){
        $(this).detach();
      });
      
      var reqs = loadOptions( '#group-constituents', [
        {
          type: 'group', 
          name_suffix: '(G)'
        },
        {
          type: 'repository',
          name_suffix: '(R)',
        },
        {
          type: 'deploy',
          name_suffix: '(D)',
        },
      ]);
      
      $.when.apply( $, reqs ).done(function(){
        $('#group-constituents').multiselect();
      });
    }

    $(document).ready(function()
    {
      $("#save-group").hide();

      var listUrl = renderAdminUrl( 'group', 'list' );
      notice( 'loading-groups', "Loading " + listUrl );
      groupTable = $("#group-panel .listing-table").dataTable({
        "bProcessing": true,
        "sAjaxSource": listUrl,
        "sAjaxDataProp": "items",
        "aoColumns": [
          {
            "sTitle": "Name",
            "bSortable": true,
            "mDataProp": "name",
          },
          {
            "sTitle": "AProx URL",
            "bSortable": true,
            "bUseRendered":false,
            "fnRender": function(o,data){return renderAccessLink('group', data);},
            "sClass": "url-cell",
            "mDataProp": "name",
          },
        ],
      });
      
      reloadGroupConstituents();
      
      clear_notice( 'loading-groups' );
    });

    $('#create-group').click(function()
    {
      var name = $('#group-name').val();
      var constituents = [];
      $("#group-constituents option:selected").each(function(){
        constituents[constituents.length] = $(this).attr('name');
      });
      
      alert( "Got constituents: " + constituents );
      
      var group = {
        "name": name,
        "constituents": constituents,
      };
      
      notice( 'group-' + name + '-created', "Saving new group: " + name );
      var url = renderAdminUrl( 'group' );
      postJSON( url, group, 'group-' + name + '-created' );
      
      groupTable.fnAddData( group );
      
      reloadGroupConstituents();
    });
    </script>
  </head>
  <body>
      <div id="group-panel" class="content-pane">
        <div class="content-pane-controls">
          <input type="button" name="save-groupss" value="Save Changes" enabled="false" />
          <input type="button" name="reset-groups" value="Discard Changes" enabled="false" />
        </div>
        <div class="existing-listing">
          <table class="listing-table" border="1">
            <tr>
              <th>Group Name</th>
              <th>Local URL</th>
              <th>Extra Attributes</th>
              <th>Controls</th>
            </tr>
            <tr>
              <td>group-1</td>
              <td>http://localhost:9080/aprox/api/1.0/group/group-1/</td>
              <td>[deployable]</td>
              <td>[del]</td>
            </tr>
            <tr>
              <td>group-2</td>
              <td>http://localhost:9080/aprox/api/1.0/group/group-2/</td>
              <td></td>
              <td>[del]</td>
            </tr>
          </table>
        </div>
        <div class="new-item">
          <form target="#add-group">
            <div class="form-line">
              Group Name: <input type="text" id="group-name" size="15" />
            </div>
            <div class="form-line">
              Group Constituents:
              <select style="min-height: 400px; min-width: 400px;" id="group-constituents" multiple="multiple">
              </select>
            </div>
            <div class="form-line form-controls">
              <input type="button" id="create-group" value="Create" />
              <input type="button" id="save-group" value="Save" />
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
